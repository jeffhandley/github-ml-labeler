name: "Labeler: Download Pull Requests"

on:
  schedule:
    - cron: '0 2 4 * *' # 02:00 UTC on the 4th day of the month

  workflow_call:
    inputs:
      label_prefix:
        description: "Label prefix"
        type: string
        default: "area-"
      page_limit:
        description: "Max pages of issues to download (100 issues per page)"
        type: number
        default: 500
        required: true
      retries:
        description: "Comma-separated list of retry delays in seconds"
        type: string
        default: "30,30,30,300,300,3600"

  workflow_dispatch:
    inputs:
      org_repo:
        description: "The org/repo to use (defaults to current repository)"
        type: string
      github_token:
        description: "The GitHub token (defaults to action token)"
        type: string
      label_prefix:
        description: "Label prefix"
        type: string
        default: "area-"
        required: true
      page_limit:
        description: "Max pages of pull requests to download (100 pulls per page)"
        type: number
        default: 500
        required: true
      retries:
        description: "Comma-separated list of retry delays in seconds"
        type: string
        default: "30,30,30,300,300,3600"

permissions:
  pull-requests: read

jobs:
  labeler-download-pulls:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: "Check out the '${{ github.action_repository }}' repo"
        uses: actions/checkout@v4
        repository: ${{ github.action_repository }}

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: "Run GitHubDownloader"
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          dotnet run --project src/GitHubDownloader -- \
            "${{ inputs.org_repo || github.repository }}" \
            "${{ inputs.github_token || secrets.GITHUB_TOKEN }}" \
            --pull-data labeler-cache/pull-data.tsv \
            --retries "${{ inputs.retries || '30,30,30,300,300,3600' }}" \
            --label-prefix "${{ inputs.label_prefix || 'area-' }}" \
            --page-limit ${{ fromJSON( inputs.page_limit || 500 ) }}

      - name: "Cache pull-data.tsv into 'github-ml-labeler/${{ inputs.org_repo || github.repository }}/download-pulls'"
        uses: actions/cache@v4
        with:
          path: labeler-cache/pull-data.tsv
          key: github-ml-labeler/${{ inputs.org_repo || github.repository }}/download-pulls
